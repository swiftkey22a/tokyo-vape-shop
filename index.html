<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOKYO VAPE ¬∑ Êù±‰∫¨</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* === –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, 'Helvetica Neue', 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0c;
            color: rgba(255, 255, 255, 0.95);
            min-height: 100vh;
            padding: 20px;
            font-weight: 400;
            letter-spacing: 0.2px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* === –•–ï–î–ï–† === */
        .header {
            text-align: center;
            padding: 32px 20px;
            margin-bottom: 28px;
            background: rgba(12, 12, 14, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.8);
            position: relative;
        }
        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 15%;
            right: 15%;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%,
                rgba(255, 255, 255, 0.3) 20%,
                rgba(255, 255, 255, 0.6) 50%,
                rgba(255, 255, 255, 0.3) 80%,
                transparent 100%);
        }
        .logo {
            font-size: 2.2rem;
            font-weight: 500;
            letter-spacing: 4px;
            margin-bottom: 12px;
            color: white;
            text-transform: uppercase;
        }
        .japanese {
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.8rem;
            letter-spacing: 3px;
            font-family: 'Hiragino Sans', 'MS Gothic', monospace;
            margin-top: 12px;
        }
        .category-tagline {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-top: 8px;
            font-weight: 300;
        }
        
        /* === –ü–û–ò–°–ö === */
        .search-box {
            margin: 24px 0;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 16px 24px 16px 52px;
            background: rgba(15, 15, 18, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            color: white;
            font-size: 1rem;
            backdrop-filter: blur(4px);
            font-weight: 400;
        }
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.35);
            font-weight: 400;
            letter-spacing: 1px;
        }
        .search-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.2);
        }
        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.4);
            font-size: 1.1rem;
        }
        
        /* === –ö–ê–¢–ï–ì–û–†–ò–ò === */
        .categories {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            margin: 24px 0;
            padding-bottom: 8px;
            scrollbar-width: none;
        }
        .category-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            letter-spacing: 1.5px;
            font-weight: 400;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .category-btn:hover {
            border-color: rgba(255, 255, 255, 0.25);
            color: rgba(255, 255, 255, 0.9);
        }
        .category-btn.active {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
        }
        
        /* === –°–ï–¢–ö–ê –î–õ–Ø –ö–ê–†–¢–û–ß–ï–ö === */
        .brands-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 20px 0 100px;
            width: 100%;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin: 20px 0 100px;
        }
        
        @media (min-width: 640px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* === –ö–ê–†–¢–û–ß–ö–ê –ë–†–ï–ù–î–ê (–§–ò–ù–ê–õ) === */
        .brand-card {
            background: rgba(12, 12, 15, 0.85);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.25s;
            display: flex;
            flex-direction: column;
            height: 280px;  /* –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ */
            cursor: pointer;
        }
        .brand-card:hover {
            background: rgba(15, 15, 18, 0.9);
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.15);
        }
        .brand-card:active {
            transform: translateY(0);
        }
        .brand-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .brand-name {
            color: white;
            font-size: 0.85rem;  /* —á—É—Ç—å –º–µ–Ω—å—à–µ */
            font-weight: 500;
            letter-spacing: 0.5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        .brand-japanese {
            color: rgba(255, 255, 255, 0.3);
            font-size: 0.65rem;
            font-family: 'MS Gothic', monospace;
            white-space: nowrap;
        }
        .brand-image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 4px 0;
            padding: 0;
            height: 120px;
            background: transparent;  /* —É–±—Ä–∞–ª–∏ —á–µ—Ä–Ω–æ—Ç—É */
        }
        .brand-image {
            width: auto;
            max-width: 100%;
            max-height: 100%;
            height: auto;
            object-fit: contain;
            border-radius: 10px;
        }
        .brand-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            color: rgba(255, 255, 255, 0.2);
            font-size: 2rem;
        }
        .brand-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 0.8rem;
        }
        .brand-strength {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.7rem;
        }
        .brand-price {
            color: white;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 40px;
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(4px);
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }
        .price-value {
            font-size: 1rem;
            font-weight: 700;
            margin: 0 2px;
        }
        .price-currency {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 400;
        }
        
        /* === –ö–ê–†–¢–û–ß–ö–ê –¢–û–í–ê–†–ê === */
        .product-card {
            background: rgba(12, 12, 15, 0.85);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.25s;
            position: relative;
        }
        .product-card:hover {
            background: rgba(15, 15, 18, 0.9);
        }
        .product-card::after {
            content: 'Êù±‰∫¨';
            position: absolute;
            bottom: 12px;
            right: 16px;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.15);
            font-family: 'MS Gothic', monospace;
        }
        .product-brand {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .product-taste {
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 16px;
            line-height: 1.45;
        }
        .product-details {
            display: flex;
            justify-content: space-between;
            color: rgba(255, 255, 255, 0.55);
            font-size: 0.8rem;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .product-price {
            color: white;
            font-size: 1.5rem;
            font-weight: 500;
            text-align: right;
            margin-bottom: 16px;
            letter-spacing: 1px;
        }
        .product-price::after {
            content: ' ‚ÇΩ';
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.45);
            margin-left: 2px;
        }
        .add-btn {
            width: 100%;
            padding: 14px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .add-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
        }
        .add-btn:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }
        
        /* === –°–¢–ê–¢–£–°–´ –ù–ê–õ–ò–ß–ò–Ø === */
        .in-stock { color: #a0e0a0; font-weight: 500; }
        .low-stock { color: #ffd280; font-weight: 500; }
        .out-stock { color: #ffa0a0; font-weight: 500; }
        
        /* === –ö–ù–û–ü–ö–ê –ö–û–†–ó–ò–ù–´ === */
        .cart-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(18, 18, 22, 0.9);
            backdrop-filter: blur(12px);
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.7rem;
            cursor: pointer;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.8);
            z-index: 1000;
            transition: all 0.25s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .cart-btn:hover {
            background: rgba(22, 22, 28, 0.95);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .cart-count {
            position: absolute;
            top: -4px;
            right: -4px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            color: black;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.15);
            font-weight: 500;
        }
        
        /* === –ú–û–î–ê–õ–ö–ê –ö–û–†–ó–ò–ù–´ === */
        .cart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .cart-overlay.show {
            display: flex;
            opacity: 1;
        }
        .cart-modal {
            background: rgba(18, 18, 22, 0.95);
            backdrop-filter: blur(12px);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            border-radius: 28px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .cart-header h2 {
            font-size: 1.5rem;
            font-weight: 400;
            letter-spacing: 2px;
            color: white;
            text-transform: uppercase;
        }
        .close-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0 8px;
            transition: color 0.2s;
            line-height: 1;
        }
        .close-btn:hover {
            color: white;
        }
        .cart-items {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            max-height: 50vh;
            padding-right: 8px;
        }
        .cart-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .cart-item-brand {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 6px;
        }
        .cart-item-taste {
            color: white;
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 12px;
        }
        .cart-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cart-item-price {
            color: #a0e0a0;
            font-size: 0.95rem;
        }
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .cart-item-controls button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: transparent;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .cart-item-controls button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .cart-item-controls button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .cart-item-quantity {
            font-size: 1.1rem;
            min-width: 24px;
            text-align: center;
            color: white;
        }
        .cart-total {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .cart-total span:first-child {
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-size: 0.9rem;
        }
        .cart-total span:last-child {
            color: white;
            font-size: 1.3rem;
            font-weight: 500;
        }
        .cart-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .cart-action-btn {
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.85);
        }
        .cart-action-btn.order {
            background: rgba(160, 224, 160, 0.15);
            border-color: rgba(160, 224, 160, 0.3);
            color: #a0e0a0;
        }
        .cart-action-btn.clear {
            background: rgba(255, 160, 160, 0.15);
            border-color: rgba(255, 160, 160, 0.3);
            color: #ffa0a0;
        }
        .cart-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
        }
        .cart-action-btn.order:hover {
            background: #a0e0a0;
            color: black;
        }
        .cart-action-btn.clear:hover {
            background: #ffa0a0;
            color: black;
        }
        
        /* === –ó–ê–ì–†–£–ó–ö–ê === */
        .loading {
            text-align: center;
            padding: 50px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 400;
            letter-spacing: 2px;
        }
        .spinner {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* === –¢–û–°–¢ –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø === */
        .toast {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(20, 20, 25, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 40px;
            padding: 14px 20px;
            color: white;
            font-size: 0.95rem;
            font-weight: 500;
            text-align: center;
            z-index: 3000;
            animation: slideDown 0.3s ease, fadeOut 0.3s ease 2s;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.8);
            max-width: 400px;
            margin: 0 auto;
            letter-spacing: 0.5px;
        }
        .toast.warning {
            border-left: 4px solid #ffd280;
        }
        .toast.success {
            border-left: 4px solid #a0e0a0;
        }
        .toast.info {
            border-left: 4px solid #a0c0ff;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* === –£–¢–ò–õ–ò–¢–´ === */
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header fade-in">
            <div class="logo">ùòõùò∞ùò¨ùò∫ùò∞ ùò∑ùò¢ùò±ùò¶ üóæ</div>
            <div class="japanese">Êù±‰∫¨„Éô„Ç§„Éó</div>
            <div class="category-tagline">LIQUID ¬∑ DEVICE ¬∑ PADS ¬∑ PARTS</div>
        </div>
        
        <div class="search-box">
            <span class="search-icon">‚ö≤</span>
            <input type="text" id="searchInput" class="search-input" placeholder="–ü–û–ò–°–ö –ü–û –í–ö–£–°–ê–ú">
        </div>
        
        <div class="categories" id="categories"></div>
        
        <div id="productsContainer">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>–ó–ê–ì–†–£–ó–ö–ê –ö–ê–¢–ê–õ–û–ì–ê</p>
            </div>
            <div id="productsGrid"></div>
        </div>
        
        <div class="cart-btn" onclick="openCart()">
            üõí
            <span class="cart-count" id="cartCount">0</span>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ö–û–†–ó–ò–ù–´ -->
    <div class="cart-overlay" id="cartOverlay" onclick="closeCartOnOverlay(event)">
        <div class="cart-modal" onclick="event.stopPropagation()">
            <div class="cart-header">
                <h2>–ö–û–†–ó–ò–ù–ê</h2>
                <button class="close-btn" onclick="closeCart()">‚úï</button>
            </div>
            <div class="cart-items" id="cartItemsList"></div>
            <div class="cart-total" id="cartTotal">
                <span>–ò–¢–û–ì–û</span>
                <span>0 ‚ÇΩ (0 —à—Ç.)</span>
            </div>
            <div class="cart-actions">
                <button class="cart-action-btn order" onclick="submitOrder()">–ó–ê–ö–ê–ó</button>
                <button class="cart-action-btn clear" onclick="clearCart()">–û–ß–ò–°–¢–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbz6NKVuQmkWsE-0Xhy53-ZxljGkLCujVOwnP_SyatMyLY4zUixLqeEjAn_4p2KROpnKDg/exec';
        const SELLER_USERNAME = 'drugsoutlety';

        let allProducts = [];
        let cart = JSON.parse(localStorage.getItem('tokyoCart')) || {};

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        let currentCategory = null;
        let currentBrand = null;

        // === –°–°–´–õ–ö–ò –ù–ê –§–û–¢–û –ë–†–ï–ù–î–û–í (–î–û–ë–ê–í–¨ –°–í–û–ò GitHub –°–°–´–õ–ö–ò) ===
        const brandImages = {
            'ANIMMA': 'https://raw.githubusercontent.com/swiftkey22a/tokyo-vape-shop/main/images/animma.jpg',
            'ANIMMA LOVE SOUR': 'https://raw.githubusercontent.com/swiftkey22a/tokyo-vape-shop/main/images/animma.jpg',
            // –¥–æ–±–∞–≤—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±—Ä–µ–Ω–¥—ã –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏
        };

        // === –Ø–ü–û–ù–°–ö–ò–ï –ù–ê–ó–í–ê–ù–ò–Ø –î–õ–Ø –≠–°–¢–ï–¢–ò–ö–ò ===
        function getJapaneseText(brand) {
            if (brand.includes('AN')) return 'Êù±‰∫¨';
            if (brand.includes('CAT')) return 'Â§ßÈò™';
            if (brand.includes('DOTA')) return 'ÂêçÂè§Â±ã';
            if (brand.includes('–ú–û–ù–ê–®')) return '‰∫¨ÈÉΩ';
            if (brand.includes('VAPO')) return 'Ê®™Êµú';
            return 'Êó•Êú¨';
        }

        // === –≠–ú–û–î–ó–ò –ü–û –í–ö–£–°–£/–ë–†–ï–ù–î–£ ===
        function getEmojiForProduct(product) {
            const taste = product.taste?.toLowerCase() || '';
            const brand = product.brand?.toLowerCase() || '';
            if (taste.includes('–≤–∏—à–Ω')) return 'üçí';
            if (taste.includes('–∞—Ä–±—É–∑')) return 'üçâ';
            if (taste.includes('–∫–ª—É–±–Ω–∏–∫')) return 'üçì';
            if (taste.includes('–º–∞–ª–∏–Ω')) return 'ü´ê';
            if (taste.includes('–∞–Ω–∞–Ω–∞—Å')) return 'üçç';
            if (taste.includes('–∞–ø–µ–ª—å—Å–∏–Ω')) return 'üçä';
            if (taste.includes('–ª–∏–º–æ–Ω')) return 'üçã';
            if (taste.includes('–≤–∏–Ω–æ–≥—Ä–∞–¥')) return 'üçá';
            if (taste.includes('–ø–µ—Ä—Å–∏–∫')) return 'üçë';
            if (taste.includes('–∫–∏–≤–∏')) return 'ü•ù';
            if (brand.includes('animma')) return 'üî•';
            if (brand.includes('–º–æ–Ω–∞—à–∫')) return 'üòà';
            if (brand.includes('vaporesso')) return '‚ö°';
            if (brand.includes('—Å–∞–º–æ—É–±–∏–π—Ü')) return 'üíÄ';
            return '‚óà';
        }

        // === –¢–û–°–¢ –£–í–ï–î–û–ú–õ–ï–ù–ò–ï ===
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 2500);
        }

        // === –û–ë–†–ê–ë–û–¢–ö–ê –ú–ê–ö–°–ò–ú–£–ú–ê ===
        function handleMaxLimit(product) {
            const messages = [
                `üí´ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è —Ö–≤–∞—Ç–∏—Ç ¬∑ ${product.stock} —à—Ç`,
                `‚ú® —ç—Ç–æ –º–∞–∫—Å–∏–º—É–º ¬∑ ${product.stock} —à—Ç`,
                `‚òØÔ∏è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ¬∑ –ª–∏–º–∏—Ç ${product.stock} —à—Ç`,
                `üå∏ –±–æ–ª—å—à–µ –Ω–µ –Ω–∞–¥–æ ¬∑ ${product.stock} —à—Ç –≤ –∫–æ—Ä–∑–∏–Ω–µ`,
                `üçµ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ ¬∑ —É–∂–µ ${product.stock} —à—Ç`
            ];
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            showToast(randomMessage, 'info');
        }

        // === –ó–ê–ì–†–£–ó–ö–ê –¢–û–í–ê–†–û–í ===
        async function loadProducts() {
            try {
                const response = await fetch(GOOGLE_SHEETS_URL + '?t=' + Date.now());
                const data = await response.json();
                if (data.success) {
                    allProducts = data.products || [];
                    renderCategories(data.categories || []);
                    currentCategory = null;
                    currentBrand = null;
                    renderCurrentView();
                    updateCartCount();
                }
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ');
                loadTestData();
            }
            document.getElementById('loading').classList.add('hidden');
        }

        // === –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï ===
        function loadTestData() {
            allProducts = [
                { id: '1', brand: 'ANIMMA', taste: 'ITACHI –í–ò–®–ù–Ø –ê–ô–°', price: 350, strength: '70MG', stock: 2, category: 'ICED' },
                { id: '2', brand: 'ANIMMA', taste: 'JUGO –ê–†–ë–£–ó –ê–ô–°', price: 350, strength: '70MG', stock: 3, category: 'ICED' },
                { id: '3', brand: 'ANIMMA', taste: 'SASUKE –ú–ê–õ–ò–ù–ê –ê–ô–°', price: 350, strength: '70MG', stock: 3, category: 'ICED' },
                { id: '4', brand: 'ANIMMA', taste: 'KAKASHI –õ–ò–ú–û–ù –ê–ô–°', price: 350, strength: '70MG', stock: 1, category: 'ICED' },
                { id: '5', brand: 'ANIMMA LOVE SOUR', taste: '–ö–ò–°–õ–´–ô –¶–ò–¢–†–£–°', price: 350, strength: '70MG', stock: 5, category: 'SOUR' },
                { id: '6', brand: 'ANIMMA LOVE SOUR', taste: '–ö–ò–°–õ–û–ï –Ø–ë–õ–û–ö–û', price: 350, strength: '70MG', stock: 3, category: 'SOUR' },
                { id: '7', brand: 'VAPORESSO XROS 5', taste: 'RED LEATHER', price: 2400, strength: '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ', stock: 1, category: 'PODS' },
                { id: '8', brand: 'CATSWILL & MALASIAN', taste: 'SOUR APPLE', price: 380, strength: '50MG', stock: 4, category: 'SOUR' },
                { id: '9', brand: 'CATSWILL & MALASIAN', taste: 'BLUEBERRY', price: 380, strength: '35MG', stock: 2, category: 'SWEET' },
                { id: '10', brand: 'DOTA', taste: 'MANGO ICE', price: 400, strength: '50MG', stock: 3, category: 'ICED' }
            ];
            renderCategories(['ICED', 'SOUR', 'SWEET', 'PODS']);
            currentCategory = null;
            currentBrand = null;
            renderCurrentView();
        }

        // === –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ö–ù–û–ü–û–ö –ö–ê–¢–ï–ì–û–†–ò–ô ===
        function renderCategories(cats) {
            const container = document.getElementById('categories');
            container.innerHTML = '<button class="category-btn" onclick="showAll()">‚óà –í–°–ï</button>';
            cats.sort().forEach(cat => {
                const activeClass = (currentCategory === cat && currentBrand === null) ? 'active' : '';
                container.innerHTML += `<button class="category-btn ${activeClass}" onclick="selectCategory('${cat}')">‚óà ${cat}</button>`;
            });
        }

        // === –í–´–ë–û–† –ö–ê–¢–ï–ì–û–†–ò–ò ===
        function selectCategory(cat) {
            currentCategory = cat;
            currentBrand = null;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(cat)) btn.classList.add('active');
            });
            renderCurrentView();
        }

        // === –ü–û–ö–ê–ó –í–°–ï–• –¢–û–í–ê–†–û–í ===
        function showAll() {
            currentCategory = null;
            currentBrand = null;
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            const allBtn = Array.from(document.querySelectorAll('.category-btn')).find(btn => btn.textContent.includes('–í–°–ï'));
            if (allBtn) allBtn.classList.add('active');
            renderCurrentView();
        }

        // === –í–´–ë–û–† –ë–†–ï–ù–î–ê ===
        function selectBrand(brand) {
            currentBrand = brand;
            renderCurrentView();
        }

        // === –ù–ê–ó–ê–î –ö –°–ü–ò–°–ö–£ –ë–†–ï–ù–î–û–í ===
        function backToBrands() {
            currentBrand = null;
            renderCurrentView();
        }

        // === –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø ===
        function renderCurrentView() {
            const grid = document.getElementById('productsGrid');

            let productsToShow = allProducts;
            if (currentCategory) {
                productsToShow = productsToShow.filter(p => p.category === currentCategory);
            }
            const query = document.getElementById('searchInput').value.toLowerCase();
            if (query) {
                productsToShow = productsToShow.filter(p =>
                    p.taste.toLowerCase().includes(query) ||
                    p.brand.toLowerCase().includes(query)
                );
            }

            // –°–ª—É—á–∞–π 1: –≤—ã–±—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±—Ä–µ–Ω–¥ ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ —Ç–æ–≤–∞—Ä—ã
            if (currentBrand) {
                const brandProducts = productsToShow.filter(p => p.brand === currentBrand);
                renderProducts(brandProducts, true);
                return;
            }

            // –°–ª—É—á–∞–π 2: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –±—Ä–µ–Ω–¥–æ–≤
            if (productsToShow.length === 0) {
                grid.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.3);">‚Äî –¢–û–í–ê–†–´ –ù–ï –ù–ê–ô–î–ï–ù–´ ‚Äî</div>';
                return;
            }

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –±—Ä–µ–Ω–¥–∞–º
            const brandsMap = new Map();
            productsToShow.forEach(p => {
                if (!brandsMap.has(p.brand)) {
                    brandsMap.set(p.brand, []);
                }
                brandsMap.get(p.brand).push(p);
            });

            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
            let html = '';
            if (currentCategory) {
                html += `
                    <div style="grid-column:1/-1; margin-bottom:20px;">
                        <button class="category-btn" onclick="showAll()" style="margin-right:10px;">‚Üê –í–°–ï</button>
                        <span style="color:rgba(255,255,255,0.5);">${currentCategory}</span>
                    </div>
                `;
            }

            // –ö–∞—Ä—Ç–æ—á–∫–∏ –±—Ä–µ–Ω–¥–æ–≤ (2 –≤ —Ä—è–¥)
            html += `<div class="brands-grid">`;

            for (let [brand, items] of brandsMap.entries()) {
                const emoji = getEmojiForProduct(items[0]);
                const imgSrc = brandImages[brand] || '';
                
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫—Ä–µ–ø–æ—Å—Ç–∏ –¥–ª—è —ç—Ç–æ–≥–æ –±—Ä–µ–Ω–¥–∞
                const strengths = [...new Set(items.map(p => p.strength).filter(s => s && !s.includes('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ')))]
                    .sort()
                    .join('¬∑');
                
                // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞
                const minPrice = Math.min(...items.map(p => p.price));
                
                // –Ø–ø–æ–Ω—Å–∫–∏–π —Ç–µ–∫—Å—Ç
                const japaneseText = getJapaneseText(brand);

                html += `
                    <div class="brand-card" onclick="selectBrand('${brand}')">
                        <div class="brand-header">
                            <span class="brand-name">${emoji} ${brand}</span>
                            <span class="brand-japanese">${japaneseText}</span>
                        </div>
                        
                        <div class="brand-image-container">
                            ${imgSrc ? 
                                `<img src="${imgSrc}" class="brand-image" loading="lazy" onerror="this.style.display='none'" alt="${brand}">` : 
                                `<div class="brand-image-placeholder">üì∑</div>`
                            }
                        </div>
                        
                        <div class="brand-footer">
                            <span class="brand-strength">${strengths || '20-50mg'}</span>
                            <span class="brand-price">
                                <span class="price-currency">–æ—Ç</span> 
                                <span class="price-value">${minPrice}</span>
                                <span class="price-currency">‚ÇΩ</span>
                            </span>
                        </div>
                    </div>
                `;
            }
            
            html += `</div>`;
            grid.innerHTML = html;
        }

        // === –†–ï–ù–î–ï–†–ò–ù–ì –¢–û–í–ê–†–û–í –ë–†–ï–ù–î–ê ===
        function renderProducts(products, showBackButton = false) {
            const grid = document.getElementById('productsGrid');
            if (!products || products.length === 0) {
                grid.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.3);">‚Äî –ù–ï–¢ –¢–û–í–ê–†–û–í ‚Äî</div>';
                return;
            }

            let html = '';
            if (showBackButton) {
                const brandName = products[0].brand;
                const japaneseText = getJapaneseText(brandName);
                html += `
                    <div style="grid-column:1/-1; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                        <button class="category-btn" onclick="backToBrands()">‚Üê –ö –ë–†–ï–ù–î–ê–ú</button>
                        <span style="color:rgba(255,255,255,0.5); font-size:0.9rem;">${brandName} <span style="font-family:'MS Gothic';">${japaneseText}</span></span>
                    </div>
                `;
            }

            html += `<div class="products-grid">`;
            products.forEach(p => {
                let stockClass = p.stock > 2 ? 'in-stock' : p.stock > 0 ? 'low-stock' : 'out-stock';
                let stockText = p.stock > 0 ? `${p.stock} —à—Ç` : '–ù–ï–¢';
                let emoji = getEmojiForProduct(p);
                html += `
                    <div class="product-card fade-in">
                        <div class="product-brand">${emoji} ${p.brand}</div>
                        <div class="product-taste">${p.taste}</div>
                        <div class="product-details">
                            <span>${p.strength || ''}</span>
                            <span class="${stockClass}">${stockText}</span>
                        </div>
                        <div class="product-price">${p.price}</div>
                        <button class="add-btn" onclick="addToCart('${p.id}')" ${p.stock <= 0 ? 'disabled' : ''}>
                            + ${p.stock <= 0 ? '–ù–ï–¢' : '–í –ö–û–†–ó–ò–ù–£'}
                        </button>
                    </div>
                `;
            });
            html += `</div>`;
            grid.innerHTML = html;
        }

        // === –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ü–û –ü–û–ò–°–ö–£ ===
        function filterProducts() {
            renderCurrentView();
        }

        // === –ö–û–†–ó–ò–ù–ê ===
        function addToCart(id) {
            let product = allProducts.find(p => p.id === id);
            if (!product || product.stock <= 0) return;
            
            if (!cart[id]) {
                cart[id] = { ...product, quantity: 1 };
                showToast(`‚úÖ +1 ${product.taste} ¬∑ 1 —à—Ç –≤ –∫–æ—Ä–∑–∏–Ω–µ`, 'success');
            } else {
                if (cart[id].quantity < product.stock) {
                    cart[id].quantity++;
                    showToast(`‚úÖ +1 ${product.taste} ¬∑ ${cart[id].quantity} —à—Ç`, 'success');
                } else {
                    handleMaxLimit(product);
                    return;
                }
            }
            saveCart();
            updateCartCount();
            animateCart();
        }

        function increaseQuantity(id) {
            let product = allProducts.find(p => p.id === id);
            if (!product) return;
            if (cart[id].quantity < product.stock) {
                cart[id].quantity++;
                saveCart();
                renderCartItems();
                updateCartCount();
            } else {
                handleMaxLimit(product);
            }
        }

        function decreaseQuantity(id) {
            if (cart[id].quantity > 1) {
                cart[id].quantity--;
                saveCart();
                renderCartItems();
                updateCartCount();
            } else {
                delete cart[id];
                saveCart();
                renderCartItems();
                updateCartCount();
            }
        }

        function saveCart() {
            localStorage.setItem('tokyoCart', JSON.stringify(cart));
        }

        function updateCartCount() {
            let total = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').textContent = total;
        }

        function animateCart() {
            let badge = document.getElementById('cartCount');
            badge.style.transform = 'scale(1.2)';
            setTimeout(() => badge.style.transform = 'scale(1)', 200);
        }

        function openCart() {
            renderCartItems();
            document.getElementById('cartOverlay').classList.add('show');
        }

        function closeCart() {
            document.getElementById('cartOverlay').classList.remove('show');
        }

        function closeCartOnOverlay(event) {
            if (event.target.classList.contains('cart-overlay')) {
                closeCart();
            }
        }

        function renderCartItems() {
            const container = document.getElementById('cartItemsList');
            const items = Object.values(cart);
            if (items.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:rgba(255,255,255,0.3);">üõí –ö–û–†–ó–ò–ù–ê –ü–£–°–¢–ê</div>';
                updateCartTotal(0, 0);
                return;
            }
            let html = '';
            let totalSum = 0;
            let totalItems = 0;
            items.forEach(item => {
                let sum = item.price * item.quantity;
                totalSum += sum;
                totalItems += item.quantity;
                html += `
                    <div class="cart-item">
                        <div class="cart-item-brand">${item.brand}</div>
                        <div class="cart-item-taste">${item.taste}</div>
                        <div class="cart-item-row">
                            <span class="cart-item-price">${item.price}‚ÇΩ √ó ${item.quantity} = ${sum}‚ÇΩ</span>
                            <div class="cart-item-controls">
                                <button onclick="decreaseQuantity('${item.id}')">‚àí</button>
                                <span class="cart-item-quantity">${item.quantity}</span>
                                <button onclick="increaseQuantity('${item.id}')" 
                                        ${item.quantity >= item.stock ? 'disabled' : ''}>+</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            updateCartTotal(totalSum, totalItems);
        }

        function updateCartTotal(sum, items) {
            document.getElementById('cartTotal').innerHTML = `
                <span>–ò–¢–û–ì–û</span>
                <span>${sum} ‚ÇΩ (${items} —à—Ç.)</span>
            `;
        }

        function submitOrder() {
            let items = Object.values(cart);
            if (items.length === 0) {
                showToast('üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞', 'warning');
                return;
            }
            let message = '';
            let total = 0;
            let totalItems = 0;
            items.forEach(item => {
                let sum = item.price * item.quantity;
                total += sum;
                totalItems += item.quantity;
                let emoji = getEmojiForProduct(item);
                message += `${emoji} ${item.brand} ‚Äî ${item.taste}\n`;
                message += `  ${item.quantity} √ó ${item.price}‚ÇΩ = ${sum}‚ÇΩ\n\n`;
            });
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            message += `–ò–¢–û–ì–û: ${total} ‚ÇΩ (${totalItems} —à—Ç.)`;
            let url = `https://t.me/${SELLER_USERNAME}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            cart = {};
            localStorage.removeItem('tokyoCart');
            updateCartCount();
            closeCart();
            showToast('‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 'success');
        }

        function clearCart() {
            if (Object.keys(cart).length > 0) {
                if (confirm('üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) {
                    cart = {};
                    localStorage.removeItem('tokyoCart');
                    updateCartCount();
                    renderCartItems();
                    showToast('üóëÔ∏è –ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞', 'info');
                }
            }
        }

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        document.getElementById('searchInput').addEventListener('input', filterProducts);

        document.addEventListener('DOMContentLoaded', () => {
            if (window.Telegram?.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.setHeaderColor('#0a0a0c');
            }
            loadProducts();
            updateCartCount();
        });
    </script>
</body>
</html>
